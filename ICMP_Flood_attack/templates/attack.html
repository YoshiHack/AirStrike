{% extends 'base.html' %}

{% block title %}ICMP Flood - Attack Configuration{% endblock %}

{% block content %}
<h1>Attack Configuration</h1>

<div class="card">
    <div class="card-header">Selected Target</div>
    <div class="card-body">
        <div id="selected-network-info" class="mb-4">
            <div class="alert alert-warning">No target selected. Please go to <a href="/scan">Network Scan</a> to select a target.</div>
        </div>
    </div>
</div>

<div class="card mb-4" id="attack-type-card">
    <div class="card-header">Select Attack Type</div>
    <div class="card-body">
        <div id="attack-options" class="attack-options">
            <div class="attack-options-row">
                <div class="attack-option" data-attack="icmp_flood">
                    <h3>ICMP Flood</h3>
                    <p>Flood target with ICMP packets to cause resource exhaustion</p>
                </div>
                <div class="attack-option" data-attack="deauth">
                    <h3>Deauthentication</h3>
                    <p>Force clients to disconnect from wireless access points</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4" id="attack-config-card" style="display: none;">
    <div class="card-header">Attack Configuration</div>
    <div class="card-body">
        <div id="attack-config">
            <!-- Attack configuration will be inserted here -->
        </div>
        <div class="d-flex justify-content-between mt-4">
            <button id="start-attack-btn" class="btn btn-primary" disabled>Start Attack</button>
            <button id="back-btn" class="btn btn-secondary">Back</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Socket.IO connection
    const socket = io();
    
    // Page elements
    const selectedNetworkInfo = document.getElementById('selected-network-info');
    const attackOptions = document.querySelectorAll('.attack-option');
    const attackConfigCard = document.getElementById('attack-config-card');
    const attackConfig = document.getElementById('attack-config');
    const startAttackBtn = document.getElementById('start-attack-btn');
    const backBtn = document.getElementById('back-btn');
    
    // Global state
    let selectedNetwork = null;
    let selectedAttack = null;
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Load selected network from session storage
        const networkJson = sessionStorage.getItem('selectedNetwork');
        if (networkJson) {
            selectedNetwork = JSON.parse(networkJson);
            displaySelectedNetwork();
        }
        
        // Attack type selection
        attackOptions.forEach(option => {
            option.addEventListener('click', () => selectAttackType(option));
        });
        
        // Button handlers
        startAttackBtn.addEventListener('click', startAttack);
        backBtn.addEventListener('click', resetAttackSelection);
    });
    
    // Display selected network info
    function displaySelectedNetwork() {
        if (!selectedNetwork) {
            return;
        }
        
        selectedNetworkInfo.innerHTML = `
            <div class="alert alert-info">
                <h4>Selected Target</h4>
                <p><strong>IP Address:</strong> ${selectedNetwork.ip}</p>
                <p><strong>MAC Address:</strong> ${selectedNetwork.BSSID}</p>
            </div>
        `;
    }
    
    // Select attack type
    function selectAttackType(attackOption) {
        // Update UI
        attackOptions.forEach(option => {
            option.classList.remove('selected');
        });
        attackOption.classList.add('selected');
        
        // Store selected attack
        selectedAttack = attackOption.dataset.attack;
        
        // Show configuration
        showAttackConfig(selectedAttack);
        
        // Show config card
        attackConfigCard.style.display = 'block';
    }
    
    // Show attack-specific configuration
    function showAttackConfig(attackType) {
        // Enable start button
        startAttackBtn.disabled = false;
        
        if (attackType === 'icmp_flood') {
            attackConfig.innerHTML = `
                <div class="alert alert-info">
                    <p><strong>ICMP Flood Attack:</strong> This attack will send a flood of ICMP packets to the target, potentially causing resource exhaustion.</p>
                    <p><strong>Target IP:</strong> ${selectedNetwork.ip}</p>
                    <p><strong>Warning:</strong> Only use this against systems you own or have permission to test.</p>
                </div>
            `;
        } else if (attackType === 'deauth') {
            attackConfig.innerHTML = `
                <div class="alert alert-warning">
                    <p>Deauthentication attack requires a wireless interface in monitor mode and is not fully implemented in this version.</p>
                </div>
                <div class="form-group">
                    <label for="deauth-client">Target Client MAC (optional):</label>
                    <input type="text" id="deauth-client" class="form-control" placeholder="FF:FF:FF:FF:FF:FF for all clients">
                </div>
                <div class="form-group">
                    <label for="deauth-count">Packet Count:</label>
                    <input type="number" id="deauth-count" class="form-control" value="10" min="1">
                </div>
                <div class="form-group">
                    <label for="deauth-interval">Interval (seconds):</label>
                    <input type="number" id="deauth-interval" class="form-control" value="0.1" min="0.1" step="0.1">
                </div>
            `;
        }
    }
    
    // Reset attack selection
    function resetAttackSelection() {
        attackOptions.forEach(option => {
            option.classList.remove('selected');
        });
        selectedAttack = null;
        attackConfigCard.style.display = 'none';
    }
    
    // Start attack
    function startAttack() {
        if (!selectedNetwork || !selectedAttack) {
            alert('Please select a target and attack type');
            return;
        }
        
        // Get attack config based on attack type
        let config = {};
        
        if (selectedAttack === 'deauth') {
            config = {
                client: document.getElementById('deauth-client').value || 'FF:FF:FF:FF:FF:FF',
                count: parseInt(document.getElementById('deauth-count').value) || 10,
                interval: parseFloat(document.getElementById('deauth-interval').value) || 0.1
            };
        }
        
        // Disable start button
        startAttackBtn.disabled = true;
        
        // Make API request
        fetch('/attacks/start_attack', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                network: selectedNetwork,
                attack_type: selectedAttack,
                config: config
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                startAttackBtn.disabled = false;
                return;
            }
            
            // Redirect to results page on success
            window.location.href = '/results';
        })
        .catch(error => {
            alert('Error starting attack: ' + error);
            console.error('Error:', error);
            startAttackBtn.disabled = false;
        });
    }
    
    // Socket.IO event handlers
    socket.on('attack_started', function(data) {
        console.log('Attack started:', data);
    });
    
    socket.on('attack_error', function(data) {
        alert('Attack error: ' + data.error);
        startAttackBtn.disabled = false;
    });
</script>
{% endblock %}
